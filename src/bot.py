import asyncio
import telebot
from datetime import datetime
from loguru import logger
from .config import get_settings
from .llm import DeepSeekLLM
from .calendar import CalendarManager

class CalendarBot:
    def __init__(self):
        self.settings = get_settings()
        self.bot = telebot.TeleBot(self.settings["telegram_token"])
        self.llm = DeepSeekLLM()
        self.calendar = CalendarManager()
        self.parsed_events = {}  # Store parsed events by message_id
        self._setup_handlers()

    def _format_datetime(self, iso_datetime: str) -> str:
        """Format ISO datetime to human readable format"""
        try:
            dt = datetime.fromisoformat(iso_datetime.replace('Z', '+00:00'))
            return dt.strftime("%d.%m.%Y %H:%M")
        except Exception as e:
            logger.error(f"Failed to format datetime: {str(e)}")
            return iso_datetime

    def _create_event_message(self, event: dict) -> str:
        """Create formatted event message"""
        parts = []
        
        if event.get("title"):
            parts.append(f"üìå {event['title']}")
            
        if event.get("start_time"):
            parts.append(f"üïí –ù–∞—á–∞–ª–æ: {self._format_datetime(event['start_time'])}")
            
        if event.get("end_time"):
            parts.append(f"üïí –ö–æ–Ω–µ—Ü: {self._format_datetime(event['end_time'])}")
            
        if event.get("location"):
            parts.append(f"üìç {event['location']}")
            
        if event.get("description"):
            parts.append(f"üìù {event['description']}")
            
        return "\n".join(parts)

    def _setup_handlers(self):
        @self.bot.message_handler(commands=['start'])
        def handle_start(message):
            welcome_text = (
                "üëã –ü—Ä–∏–≤–µ—Ç! –Ø –±–æ—Ç –¥–ª—è –¥–æ–±–∞–≤–ª–µ–Ω–∏—è —Å–æ–±—ã—Ç–∏–π –≤ –∫–∞–ª–µ–Ω–¥–∞—Ä—å.\n\n"
                "–ü—Ä–æ—Å—Ç–æ –Ω–∞–ø–∏—à–∏ –º–Ω–µ –æ —Å–æ–±—ã—Ç–∏–∏, –Ω–∞–ø—Ä–∏–º–µ—Ä:\n"
                "‚Ä¢ –ó–∞–≤—Ç—Ä–∞ –≤ 15:00 –≤—Å—Ç—Ä–µ—á–∞ —Å –∫–ª–∏–µ–Ω—Ç–æ–º\n"
                "‚Ä¢ 25 –º–∞—Ä—Ç–∞ –≤ 11 —É—Ç—Ä–∞ –ª–µ–∫—Ü–∏—è –æ —è–ø–æ–Ω—Å–∫–æ–º —Å–∏–º–≤–æ–ª–∏–∑–º–µ\n"
                "‚Ä¢ –í—Å—Ç—Ä–µ—á–∞ –≤ –æ—Ñ–∏—Å–µ –≤ –ø–æ–Ω–µ–¥–µ–ª—å–Ω–∏–∫ –≤ 10:00\n\n"
                "–Ø –ø–æ–π–º—É —Ç–µ–∫—Å—Ç –∏ –¥–æ–±–∞–≤–ª—é —Å–æ–±—ã—Ç–∏–µ –≤ —Ç–≤–æ–π –∫–∞–ª–µ–Ω–¥–∞—Ä—å."
            )
            self.bot.reply_to(message, welcome_text)

        @self.bot.message_handler(func=lambda message: True)
        def handle_message(message):
            try:
                logger.info(f"Received message from {message.from_user.id}: {message.text}")
                self.bot.send_chat_action(message.chat.id, 'typing')
                event = asyncio.run(self.llm.parse_calendar_event(message.text))
                
                if not event:
                    self.bot.reply_to(
                        message,
                        "–ù–µ —É–¥–∞–ª–æ—Å—å –æ–±—Ä–∞–±–æ—Ç–∞—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –µ—â–µ —Ä–∞–∑."
                    )
                    return
                
                if not event["result"]:
                    self.bot.reply_to(
                        message,
                        f"–ù–µ —É–¥–∞–ª–æ—Å—å —Ä–∞—Å–ø–∞—Ä—Å–∏—Ç—å —Å–æ–±—ã—Ç–∏–µ: {event['comment']}"
                    )
                    return
                
                # Create inline keyboard
                keyboard = telebot.types.InlineKeyboardMarkup()
                keyboard.row(
                    telebot.types.InlineKeyboardButton("‚úÖ –î–æ–±–∞–≤–∏—Ç—å –≤ –∫–∞–ª–µ–Ω–¥–∞—Ä—å", callback_data="add")
                )
                
                # Send event preview with buttons
                preview_message = self.bot.reply_to(
                    message,
                    f"–ü—Ä–æ–≤–µ—Ä—å—Ç–µ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ —Å–æ–±—ã—Ç–∏–∏:\n\n{self._create_event_message(event)}",
                    reply_markup=keyboard
                )
                
                # Store parsed event in memory
                self.parsed_events[preview_message.message_id] = event
                
            except Exception as e:
                logger.error(f"Error processing message: {str(e)}")
                self.bot.reply_to(message, "–ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±—Ä–∞–±–æ—Ç–∫–µ —Å–æ–æ–±—â–µ–Ω–∏—è. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –µ—â–µ —Ä–∞–∑.")

        @self.bot.callback_query_handler(func=lambda call: True)
        def handle_callback(call):
            try:
                action = call.data
                
                if action == 'add':
                    # Get parsed event from memory
                    event = self.parsed_events.get(call.message.message_id)
                    if not event:
                        self.bot.answer_callback_query(call.id, "–û—à–∏–±–∫–∞: –Ω–µ —É–¥–∞–ª–æ—Å—å –Ω–∞–π—Ç–∏ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ —Å–æ–±—ã—Ç–∏–∏")
                        return
                    
                    # Add event to calendar
                    success = self.calendar.add_event(
                        title=event["title"],
                        start_time=event["start_time"],
                        end_time=event["end_time"],
                        description=event["description"],
                        location=event["location"]
                    )
                    
                    if success:
                        self.bot.answer_callback_query(call.id, "‚úÖ –°–æ–±—ã—Ç–∏–µ –¥–æ–±–∞–≤–ª–µ–Ω–æ –≤ –∫–∞–ª–µ–Ω–¥–∞—Ä—å")
                        # Update button text
                        keyboard = telebot.types.InlineKeyboardMarkup()
                        keyboard.row(
                            telebot.types.InlineKeyboardButton("‚úÖ –£—Å–ø–µ—à–Ω–æ –¥–æ–±–∞–≤–ª–µ–Ω–æ", callback_data="added")
                        )
                        self.bot.edit_message_reply_markup(
                            chat_id=call.message.chat.id,
                            message_id=call.message.message_id,
                            reply_markup=keyboard
                        )
                        # Clean up
                        del self.parsed_events[call.message.message_id]
                    else:
                        self.bot.answer_callback_query(call.id, "‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –¥–æ–±–∞–≤–ª–µ–Ω–∏–∏ —Å–æ–±—ã—Ç–∏—è")
                        
                elif action == 'added':
                    self.bot.answer_callback_query(call.id, "–≠—Ç–æ —Å–æ–±—ã—Ç–∏–µ —É–∂–µ –¥–æ–±–∞–≤–ª–µ–Ω–æ –≤ –∫–∞–ª–µ–Ω–¥–∞—Ä—å")
                    
            except Exception as e:
                logger.error(f"Error handling callback: {str(e)}")
                self.bot.answer_callback_query(call.id, "–ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞")

    def run(self):
        logger.info("Starting bot...")
        self.bot.infinity_polling()
